<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Tamu Undangan Offline</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================================================= */
        /* === Variabel dan Gaya Dasar Tema (TIDAK BERUBAH) === */
        /* ================================================= */
        :root {
            /* Warna Dasar */
            --bg-primary: #f0f0f5; 
            --bg-card: rgba(255, 255, 255, 0.5); 
            --text-main: #333333; 
            --text-subtle: #666666; 
            --accent-1: #08978b; /* Primer/Simpan */
            --accent-2: #ff6932; /* Hapus */
            --accent-3: #08978B; /* Tab Aktif/Edit/Salin */
            --border-color: rgba(0, 0, 0, 0.1); 
            
            /* Dimensi - Disesuaikan agar lebih ringkas */
            --glass-br: 8px; 
            --font-size-base: 0.75rem; 
            --padding-base: 0.6em; 

            /* Shadow & Warna Aksi */
            --shadow-light: rgba(0, 0, 0, 0.1);
            --color-delete: var(--accent-2); 
            --color-save: var(--accent-1); 
            --color-copy: var(--accent-3); 
            --color-edit: var(--accent-3); /* Menggunakan warna aksen 3 untuk Edit */
        }

        /* --- Gaya Umum untuk body --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            min-height: 100vh;
            padding: 1em; 
            font-size: var(--font-size-base); 
        }
        
        /* --- Kontainer utama (Card-like container) --- */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(6px) saturate(180%);
            -webkit-backdrop-filter: blur(6px) saturate(180%);
            border: 1px solid var(--border-color);
            box-shadow: 0 3px 9px var(--shadow-light); 
            padding: 1em; 
            border-radius: var(--glass-br);
        }

        /* --- Kontainer Utama untuk batasan lebar --- */
        .main-container {
            max-width: 540px; 
            margin-left: auto;
            margin-right: auto;
            space-y: 0.8em; 
        }
        
        /* --- Header dan Judul --- */
        header h1 {
            font-size: 1.4rem; 
            font-weight: 700;
            color: var(--accent-1); 
        }
        header h1 .text-delete-color {
            color: var(--color-delete); 
        }
        header p {
            color: var(--text-subtle);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; 
        }
        
        /* --- Tombol Aksi Utama (Save) --- */
        .btn-primary {
            background-color: var(--color-save); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            box-shadow: 0 1px 4px rgba(8, 151, 139, 0.3); 
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #046c63; 
            transform: translateY(-1px);
        }
        
        /* === Gaya Tombol Hapus (untuk Modal Hapus) === */
        .btn-delete {
            background-color: var(--color-delete); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            box-shadow: 0 1px 4px rgba(255, 105, 50, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-delete:hover:not(:disabled) {
            background-color: #e04a1f; 
            transform: translateY(-1px);
        }

        /* --- Tombol Aksi Tabel (Edit/Hapus) --- */
        .btn-table-action {
            /* Membuat tombol lebih kecil dan merata */
            font-size: 0.7rem; 
            padding: 0.3rem; 
            width: 1.6rem; 
            height: 1.6rem; 
            border-radius: 3px; 
            color: white; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        /* Gaya Khusus untuk tombol Edit */
        .btn-edit {
            background-color: var(--color-edit);
        }
        .btn-edit:hover:not(:disabled) {
            background-color: #046c63; /* Warna hover sama dengan Save */
        }
        /* Gaya Khusus untuk tombol Hapus */
        .btn-remove {
            background-color: var(--color-delete); 
        }
        .btn-remove:hover:not(:disabled) {
            background-color: #e04a1f; 
        }

        /* --- Input Field --- */
        input[type="text"] {
            border: 1px solid var(--border-color);
            border-radius: 5px; 
            padding: 0.5rem; 
            font-size: 0.8rem; 
        }
        
        /* --- Tabel Styling --- */
        .data-table thead th {
            font-size: 0.7rem; 
            padding: 0.5rem 0.6rem; 
        }
        .data-table tbody td {
            padding: 0.5rem 0.6rem; 
            font-size: 0.75rem; 
            vertical-align: middle; 
        }

        /* --- Header tabel harus sticky dengan background solid --- */
        .data-table thead th {
            position: sticky; 
            top: 0; 
            z-index: 10; 
            background-color: white; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
        }

        /* --- Gaya Scrollable Data --- */
        .scrollable-data {
            max-height: 350px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color);
            border-radius: var(--glass-br);
        }

        /* --- Gaya Toggle Switch Status Undangan --- */
        .toggle-switch {
            width: 65px; 
            height: 22px; 
            position: relative;
            display: inline-block;
        }
        /* Input disembunyikan */
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px; 
        }
        .slider:before {
            position: absolute;
            content: "BELUM";
            height: 16px; 
            width: 30px; 
            left: 3px; 
            bottom: 3px; 
            background-color: #ff5733; 
            transition: .4s;
            border-radius: 16px; 
            line-height: 16px; 
            text-align: center;
            color: white;
            font-weight: 600;
            font-size: 7px; 
        }
        input:checked + .slider {
            background-color: #08978b; 
        }
        input:checked + .slider:before {
            transform: translateX(39px); /* Disesuaikan dengan lebar toggle switch */
            background-color: #046c63; 
            content: "SUDAH";
        }
        
        /* --- Modal Styling --- */
        .modal {
            transition: all 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
            display: flex; 
        }
        .modal-open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            padding: 1.2em; 
            transform: translateY(-15px); 
            transition: transform 0.3s ease-out;
        }
        .modal-open .modal-content {
            transform: translateY(0);
        }

        /* --- Toast Styling (Notifikasi) --- */
        #toastModal {
            bottom: 15px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            pointer-events: none;
        }
        .toast-content {
            padding: 0.5rem 1rem; 
            border-radius: 7px; 
            font-size: 0.8rem; 
            color: white;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            opacity: 0;
            transform: translateY(15px); 
        }
        .toast-show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: var(--accent-1); border-color: #046c63; }
        .toast-error { background-color: var(--accent-2); border-color: #E55A29; }
        .toast-info { background-color: var(--accent-3); border-color: #1e40ef; }

        /* --- Gaya Tab Navigasi --- */
        .tab-button {
            padding: 0.4rem 0.8rem; 
            font-weight: 600;
            border-radius: 5px; 
            color: var(--text-subtle);
            font-size: 0.8rem; 
            transition: all 0.2s ease;
        }
        .tab-button:hover { 
            background-color: #046c63; 
            color: white; 
        }
        .tab-active {
            background-color: var(--accent-3); 
            color: white;
            box-shadow: 0 1px 4px rgba(37, 99, 235, 0.3); 
        }
        /* Aturan untuk tab aktif agar tidak berubah warna saat di hover */
        .tab-active:hover {
            background-color: var(--accent-3); 
            color: white;
        }


    </style>
</head>
<body class="min-h-screen">

    <div class="main-container mx-auto space-y-3">
        <header class="text-center pt-1 pb-1">
            <h1 class="font-extrabold mb-0.5">Daftar Tamu <span class="text-delete-color">Offline</span></h1>
            <p class="text-xs text-gray-600">List Tamu Undangan Kita • Chusnul & Tri • 2025 </p>
        </header>

        <div class="flex justify-between glass-card p-0.5 shadow-sm border-b border-gray-200">
            <button 
                id="tabChusnul" 
                onclick="changeSheet('Tamu Chusnul')"
                class="tab-button tab-active">
                Tamu Chusnul
            </button>
            <button 
                id="tabTri" 
                onclick="changeSheet('Tamu Tri')"
                class="tab-button">
                Tamu Tri
            </button>
        </div>

        <div id="messageArea" class="hidden"></div>
        
        <div class="glass-card">
            <h2 class="text-sm font-semibold text-gray-800 mb-2" id="inputSectionTitle">Input Data Baru (Tamu Chusnul)</h2>
            <form id="dataForm" class="flex flex-col sm:flex-row space-y-1.5 sm:space-y-0 sm:space-x-1.5">
                <input
                    type="text"
                    id="inputNama"
                    placeholder="Masukkan Nama Lengkap"
                    required
                    class="flex-grow shadow-sm"
                >
                <button
                    type="submit"
                    id="saveButton"
                    class="btn-primary font-semibold shadow-md hover:shadow-lg transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center"
                >
                    <span id="saveButtonText">Simpan Data</span>
                    <svg id="saveSpinner" class="animate-spin -ml-1 mr-1 h-3 w-3 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <div class="glass-card">
            <h2 class="text-sm font-semibold text-gray-800 mb-2" id="dataSectionTitle">Data Tersimpan (Tamu Chusnul)</h2>
            
            <div id="loadingIndicator" class="text-center py-3 text-xs text-gray-500">
                <svg class="animate-spin h-5 w-5 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-0.5">Memuat data...</p>
            </div>

            <div class="overflow-x-auto scrollable-data shadow-inner bg-white bg-opacity-80">
                <table class="min-w-full data-table border-collapse" id="dataTable">
                    <thead>
                        <tr class="text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                            <th class="py-1.5 px-2 sticky top-0 z-10">No.</th>
                            <th class="py-1.5 px-2 sticky top-0 z-10">Nama</th>
                            <th class="py-1.5 px-2 text-center sticky top-0 z-10 w-24">Status</th>
                            <th class="py-1.5 px-2 text-center sticky top-0 z-10 w-16">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            
            <p id="noDataMessage" class="hidden text-center py-2 text-gray-500 text-xs">Belum ada data yang tersimpan.</p>
        </div>
    </div>

    <div id="editModal" class="modal modal-closed fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 p-2">
        <div class="modal-content p-3 w-full max-w-xs">
            <h3 class="text-base font-bold mb-2">Edit Data Nama</h3>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="mb-2">
                    <label for="editNama" class="block text-xs font-medium text-gray-700 mb-0.5">Nama Lengkap</label>
                    <input
                        type="text"
                        id="editNama"
                        required
                        class="w-full shadow-sm text-xs" >
                </div>
                <div class="flex justify-end space-x-1.5">
                    <button
                        type="button"
                        onclick="closeEditModal()"
                        class="bg-gray-200 text-gray-700 font-semibold py-1 px-2 rounded-md text-xs hover:bg-gray-300 transition duration-150" >
                        Batal
                    </button>
                    <button
                        type="submit"
                        id="updateButton"
                        class="btn-primary text-white font-semibold py-1 px-2 rounded-md shadow-md hover:shadow-lg transition duration-150 ease-in-out disabled:opacity-50 text-xs" >
                        Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal modal-closed fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 p-2">
        <div class="modal-content p-3 w-full max-w-xs">
            <h3 class="text-base font-bold mb-2 text-gray-800"><i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> Konfirmasi Hapus</h3>
            <p id="confirmMessage" class="mb-3 text-gray-700 text-xs">Apakah Anda yakin ingin menghapus data ini? Aksi ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end space-x-1.5">
                <button
                    type="button"
                    onclick="closeConfirmModal(false)"
                    class="bg-gray-200 text-gray-700 font-semibold py-1 px-2 rounded-md text-xs hover:bg-gray-300 transition duration-150" >
                    Batal
                </button>
                <button
                    type="button"
                    id="confirmDeleteButton"
                    class="btn-delete text-white font-semibold py-1 px-2 rounded-md shadow-md hover:shadow-lg transition duration-150 ease-in-out text-xs" >
                    <i class="fas fa-trash-alt mr-0.5"></i> Ya, Hapus
                </button>
            </div>
        </div>
    </div>
    
    <div id="toastModal" class="fixed">
        <div id="toastContent" class="toast-content text-center shadow-lg border-2">
            </div>
    </div>
    
    <script>
        // ====================================================================
        // KONFIGURASI PENTING
        // ====================================================================
        // URL Apps Script Anda yang sebenarnya. HARUS DIGANTI!
        const GS_URL = 'https://script.google.com/macros/s/AKfycbwOdpSb9F2J6mZzEfg9Mf7tF0Xwv4AhOYi6qpwEMCaQdaec0dks23W3DBb2inzKucID2A/exec';
        
        // Nama Sheet/Kategori 
        const SHEET_CHUSNUL = 'Tamu Chusnul';
        const SHEET_TRI = 'Tamu Tri';
        
        // Variabel global untuk menentukan sheet/kategori yang aktif
        let currentSheet = SHEET_CHUSNUL;
        
        // BASE URL UNDANGAN (Dibiarkan untuk konsistensi)
        const BASE_INVITATION_URL = 'https://tewetech.github.io/wedding-of-chusnul-tri/';
        
        // Variabel untuk menyimpan fungsi callback hapus 
        let deleteCallback = null;
        
        // ====================================================================
        
        // Elemen DOM yang digunakan (Diambil dari ID HTML)
        const dataForm = document.getElementById('dataForm'); 
        const inputNama = document.getElementById('inputNama'); 
        const tableBody = document.getElementById('tableBody'); 
        const loadingIndicator = document.getElementById('loadingIndicator'); 
        const noDataMessage = document.getElementById('noDataMessage'); 
        const editModal = document.getElementById('editModal'); 
        const editForm = document.getElementById('editForm'); 
        const editId = document.getElementById('editId'); 
        const editNama = document.getElementById('editNama'); 
        const saveButton = document.getElementById('saveButton'); 
        const saveButtonText = document.getElementById('saveButtonText'); 
        const saveSpinner = document.getElementById('saveSpinner'); 
        const inputSectionTitle = document.getElementById('inputSectionTitle'); 
        const dataSectionTitle = document.getElementById('dataSectionTitle'); 
        const tabChusnul = document.getElementById('tabChusnul'); 
        const tabTri = document.getElementById('tabTri'); 
        
        // Elemen DOM untuk Notifikasi
        const toastModal = document.getElementById('toastModal'); 
        const toastContent = document.getElementById('toastContent'); 
        
        // Elemen DOM untuk Modal Konfirmasi Hapus
        const confirmModal = document.getElementById('confirmModal'); 
        const confirmMessage = document.getElementById('confirmMessage'); 
        const confirmDeleteButton = document.getElementById('confirmDeleteButton'); 

        // Variabel global untuk menyimpan data yang sedang aktif
        let currentData = [];

        // --------------------------------------------------------------------
        // FUNGSI UTILITY (PEMBANTU)
        // --------------------------------------------------------------------

        /**
         * Menampilkan pesan notifikasi kecil (toast/popup).
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {'success'|'error'|'info'} type - Tipe notifikasi.
         */
        function showToast(message, type) {
            let icon = '';
            let colorClass = '';
            
            if (type === 'success') {
                icon = '<i class="fas fa-check-circle mr-1"></i>';
                colorClass = 'toast-success';
            } else if (type === 'error') {
                icon = '<i class="fas fa-times-circle mr-1"></i>';
                colorClass = 'toast-error';
            } else if (type === 'info') { 
                icon = '<i class="fas fa-info-circle mr-1"></i>';
                colorClass = 'toast-info';
            }
            
            toastContent.innerHTML = `${icon}${message}`;
            toastContent.className = `toast-content ${colorClass}`;
            
            // Tampilkan toast
            setTimeout(() => {
                toastContent.classList.add('toast-show');
            }, 50); 

            // Hilangkan toast setelah 4 detik
            setTimeout(() => {
                toastContent.classList.remove('toast-show');
                setTimeout(() => {
                    toastContent.className = 'toast-content';
                }, 300); 
            }, 4000); 
        }

        /**
         * Mengatur status tombol Simpan saat memproses data (loading).
         * @param {boolean} isLoading - Status loading.
         * @param {string} text - Teks yang ditampilkan pada tombol saat tidak loading.
         */
        function setSaveLoading(isLoading, text = 'Simpan Data') {
            saveButton.disabled = isLoading;
            saveButtonText.textContent = text;
            if (isLoading) {
                saveButtonText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');
            } else {
                saveButtonText.classList.remove('hidden');
                saveSpinner.classList.add('hidden');
            }
        }
        
        // --------------------------------------------------------------------
        // FUNGSI PENGATUR KATEGORI (SHEET) 
        // --------------------------------------------------------------------

        /**
         * Mengubah sheet/kategori yang aktif dan memuat ulang data.
         * @param {string} sheetName - Nama sheet ('Tamu Chusnul' atau 'Tamu Tri').
         */
        window.changeSheet = (sheetName) => {
            if (currentSheet === sheetName) return; 

            currentSheet = sheetName;
            
            // Perbarui tampilan tab aktif
            tabChusnul.classList.remove('tab-active');
            tabTri.classList.remove('tab-active');
            if (sheetName === SHEET_CHUSNUL) {
                tabChusnul.classList.add('tab-active');
            } else if (sheetName === SHEET_TRI) {
                tabTri.classList.add('tab-active');
            }

            // Perbarui judul bagian input dan data
            inputSectionTitle.textContent = `Input Data Baru (${currentSheet})`;
            dataSectionTitle.textContent = `Data Tersimpan (${currentSheet})`;

            // Muat ulang data 
            fetchData();
        }

        // --------------------------------------------------------------------
        // FUNGSI UTAMA INTERAKSI DENGAN APPS SCRIPT 
        // --------------------------------------------------------------------

        /**
         * Mengirim permintaan POST ke Google Apps Script.
         * @param {Object} data - Objek data yang akan dikirim.
         * @returns {Promise<Object>} - Hasil dari Apps Script.
         */
        async function postToGS(data) {
            data.sheet = currentSheet; // Tambahkan nama sheet ke data

            try {
                const response = await fetch(GS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(data) // Mengirim data sebagai form URL-encoded
                });

                if (!response.ok) {
                    throw new Error(`Jaringan bermasalah, status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status === 'ERROR') {
                    throw new Error(result.message || 'Operasi gagal di sisi Apps Script.');
                }
                
                return result;

            } catch (error) {
                console.error('Fetch Error:', error);
                throw new Error(`Gagal terhubung ke server: ${error.message}`);
            }
        }

        /**
         * Mengambil semua data dari Google Spreadsheet untuk sheet aktif.
         */
        async function fetchData() {
            loadingIndicator.classList.remove('hidden'); 
            tableBody.innerHTML = ''; 
            noDataMessage.classList.add('hidden');

            try {
                const url = `${GS_URL}?action=READ&sheet=${encodeURIComponent(currentSheet)}`;
                const response = await fetch(url, { method: 'GET' });
                
                if (!response.ok) throw new Error(`Gagal mengambil data, status: ${response.status}`);
                
                const result = await response.json();
                currentData = Array.isArray(result.data) ? result.data : []; // Simpan data di variabel global
                renderTable(currentData); // Render data ke tabel
                
            } catch (error) {
                console.error('Fetch Data Error:', error);
                showToast(`Gagal memuat data: ${error.message}`, 'error');
                loadingIndicator.classList.add('hidden');
            }
        }

        // --------------------------------------------------------------------
        // FUNGSI UNTUK MERENDER DATA DAN INTERAKSI UI 
        // --------------------------------------------------------------------

        /**
         * Merender array data dari Apps Script ke dalam tabel HTML.
         * @param {Array<Array<any>>} data - Data tamu dari Google Sheet.
         */
        function renderTable(data) {
            loadingIndicator.classList.add('hidden');
            tableBody.innerHTML = ''; 
            
            if (data.length === 0) {
                noDataMessage.classList.remove('hidden');
                noDataMessage.textContent = `Belum ada data yang tersimpan di sheet: ${currentSheet}.`;
                return;
            }

            noDataMessage.classList.add('hidden');
            
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-50', 'transition', 'duration-100');
                
                // Ambil data: [Timestamp, ID, Nama, Status]
                const id = row[1];
                const nama = row[2];
                const status = row[3] || 'BELUM'; 
                
                const isChecked = status.toUpperCase() === 'SUDAH';
                const checkedAttribute = isChecked ? 'checked' : '';

                // Escape karakter kutipan tunggal untuk digunakan dalam pemanggilan fungsi inline
                const escapedNama = nama.replace(/'/g, "\\'"); 

                tr.innerHTML = `
                    <td class="py-1.5 px-2 whitespace-nowrap">${index + 1}</td>
                    <td 
                        class="py-1.5 px-2 font-medium text-gray-900" 
                    >
                        ${nama}
                    </td>
                    
                    <td class="py-1.5 px-2 text-center">
                        <div class="flex justify-center items-center h-full">
                            <label class="toggle-switch">
                                <input 
                                    type="checkbox" 
                                    ${checkedAttribute} 
                                    onclick="updateInvitationStatus('${id}', this.checked, '${escapedNama}')"
                                >
                                <span class="slider"></span>
                            </label>
                        </div>
                    </td>

                    <td class="py-1.5 px-2 whitespace-nowrap text-center">
                        <div class="flex justify-center items-center space-x-1">
                            <button onclick="openEditModal('${id}', '${escapedNama}')" class="btn-table-action btn-edit hover:bg-green-700" title="Edit Nama">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="openConfirmDelete('${id}', '${escapedNama}')" class="btn-table-action btn-remove hover:bg-red-700" title="Hapus Data">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        // --------------------------------------------------------------------
        // HANDLER EVENT FORM SUBMISSION (SIMPAN BARU) 
        // --------------------------------------------------------------------

        dataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nama = inputNama.value.trim();

            if (!nama) {
                showToast('Nama tidak boleh kosong.', 'error');
                return;
            }

            setSaveLoading(true, 'Menyimpan...');

            try {
                const data = {
                    action: 'SAVE',
                    nama: nama,
                    status: 'BELUM' 
                };
                
                await postToGS(data);
                
                showToast(`Data "${nama}" berhasil disimpan di ${currentSheet}!`, 'success');
                inputNama.value = ''; 
                fetchData(); // Muat ulang data tabel

            } catch (error) {
                showToast(`Gagal menyimpan data: ${error.message}`, 'error');
            } finally {
                setSaveLoading(false, 'Simpan Data');
            }
        });


        // --------------------------------------------------------------------
        // FUNGSI EDIT DAN HAPUS DATA 
        // --------------------------------------------------------------------

        /**
         * Membuka modal edit data.
         * @param {string} id - ID data yang akan diedit.
         * @param {string} nama - Nama tamu saat ini.
         */
        window.openEditModal = (id, nama) => {
            editId.value = id;
            editNama.value = nama;
            editModal.classList.remove('modal-closed');
            editModal.classList.add('modal-open');
        }

        /**
         * Menutup modal edit data.
         */
        window.closeEditModal = () => {
            editModal.classList.remove('modal-open');
            editModal.classList.add('modal-closed');
        }

        /**
         * Handler form submit untuk update data nama (dari modal edit).
         */
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = editId.value;
            const newNama = editNama.value.trim();

            if (!newNama || !id) {
                showToast('Nama atau ID tidak valid.', 'error');
                return;
            }

            const updateButton = document.getElementById('updateButton');
            updateButton.disabled = true;
            updateButton.textContent = 'Memperbarui...';

            try {
                const data = {
                    action: 'UPDATE', // Menggunakan aksi UPDATE yang sudah ada di Apps Script
                    id: id,
                    nama: newNama
                };

                await postToGS(data);
                
                showToast(`Data ID ${id.substring(0, 5)}... berhasil diperbarui di ${currentSheet} menjadi "${newNama}".`, 'success');
                closeEditModal();
                fetchData(); // Muat ulang data

            } catch (error) {
                showToast(`Gagal memperbarui data: ${error.message}`, 'error');
            } finally {
                updateButton.disabled = false;
                updateButton.textContent = 'Simpan Perubahan';
            }
        });
        
        /**
         * Membuka modal konfirmasi hapus.
         * @param {string} id - ID data yang akan dihapus.
         * @param {string} nama - Nama tamu yang akan dihapus.
         */
        window.openConfirmDelete = (id, nama) => {
            confirmMessage.innerHTML = `Apakah Anda yakin ingin menghapus data untuk <strong>"${nama}"</strong> (di ${currentSheet})? Aksi ini tidak dapat dibatalkan.`;
            
            // Set callback untuk eksekusi hapus jika dikonfirmasi
            deleteCallback = () => executeDeleteData(id, nama);
            
            confirmModal.classList.remove('modal-closed');
            confirmModal.classList.add('modal-open');
        }
        
        /**
         * Menutup modal konfirmasi hapus dan menjalankan callback jika dikonfirmasi.
         * @param {boolean} isConfirmed - Status konfirmasi (Ya/Tidak).
         */
        window.closeConfirmModal = (isConfirmed) => {
            confirmModal.classList.remove('modal-open');
            confirmModal.classList.add('modal-closed');

            if (isConfirmed && deleteCallback) {
                deleteCallback(); // Jalankan fungsi hapus
            } else if (!isConfirmed) {
                showToast('Penghapusan dibatalkan.', 'info');
            }
            deleteCallback = null; // Reset callback
        }
        
        // Listener untuk tombol 'Ya, Hapus' di modal
        confirmDeleteButton.addEventListener('click', () => {
            closeConfirmModal(true);
        });

        /**
         * Fungsi yang menjalankan proses penghapusan data sebenarnya ke Apps Script.
         * @param {string} id - ID data yang akan dihapus.
         * @param {string} nama - Nama tamu yang dihapus (untuk notifikasi).
         */
        async function executeDeleteData(id, nama) {
            try {
                const data = {
                    action: 'DELETE',
                    id: id
                };

                loadingIndicator.classList.remove('hidden'); 

                await postToGS(data);
                
                showToast(`Data "${nama}" berhasil dihapus dari ${currentSheet}.`, 'success');
                fetchData(); // Muat ulang data tabel

            } catch (error) {
                showToast(`Gagal menghapus data: ${error.message}`, 'error');
                loadingIndicator.classList.add('hidden'); 
            } 
        }
        
        /**
         * Memperbarui status undangan tamu di Google Sheet menggunakan toggle switch.
         * @param {string} id - ID data yang akan diperbarui.
         * @param {boolean} isChecked - Status toggle (true=SUDAH, false=BELUM).
         * @param {string} nama - Nama tamu (untuk notifikasi).
         */
        window.updateInvitationStatus = async (id, isChecked, nama) => {
            const newStatus = isChecked ? 'SUDAH' : 'BELUM';
            
            try {
                const data = {
                    action: 'UPDATE_STATUS', 
                    id: id,
                    status: newStatus
                };

                await postToGS(data);
                
                showToast(`Status undangan untuk "${nama}" berhasil diperbarui menjadi *${newStatus}*.`, 'success');
                
                // Update data lokal agar tabel tidak perlu di-render ulang
                const indexToUpdate = currentData.findIndex(row => row[1] === id); 
                if (indexToUpdate !== -1) {
                    currentData[indexToUpdate][3] = newStatus;
                }

            } catch (error) {
                showToast(`Gagal memperbarui status: ${error.message}`, 'error');
                // Kembalikan posisi saklar jika gagal
                document.querySelector(`input[onclick*="${id}"]`).checked = !isChecked;
            }
        }

        // --------------------------------------------------------------------
        // INISIALISASI
        // --------------------------------------------------------------------

        // Panggil fetchData saat dokumen selesai dimuat 
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
